#!/usr/bin/env python3
import os
import sys
import json
import argparse
import subprocess
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(description="Run Verilog to GDS using LibreLane natively.")
    parser.add_argument("verilog_file", help="Path to the Verilog source file")
    parser.add_argument("--module", "-m", help="Top module name (defaults to verilog filename without extension)")
    parser.add_argument("--clock-port", "-c", default="clk", help="Name of the clock port (default: clk)")
    parser.add_argument("--clock-period", "-p", type=float, default=10.0, help="Clock period in ns (default: 10.0)")
    parser.add_argument("--utilization", "-u", type=float, default=10, help="Core utilization percentage (default: 10)")
    parser.add_argument("--pdk", default="ihp-sg13g2", help="PDK to use (default: ihp-sg13g2)")
    parser.add_argument("--full-timing", action="store_true", help="Run all 3 timing corners (slow but thorough, default: typical only)")
    
    args = parser.parse_args()

    verilog_path = Path(args.verilog_file).resolve()
    if not verilog_path.exists():
        print(f"Error: Verilog file '{verilog_path}' not found.")
        sys.exit(1)

    top_module = args.module if args.module else verilog_path.stem
    project_dir = verilog_path.parent.resolve()
    run_dir = project_dir / f"{top_module}_run"
    
    # 1. Prepare run directory
    print(f"[*] Preparing workspace: {run_dir}")
    os.makedirs(run_dir / "src", exist_ok=True)
    subprocess.run(["cp", str(verilog_path), str(run_dir / "src/")], check=True)

    # 2. Generate config.json (forcing SCL to avoid env conflicts)
    config = {
        "DESIGN_NAME": top_module,
        "VERILOG_FILES": f"dir::src/{verilog_path.name}",
        "CLOCK_PORT": args.clock_port,
        "CLOCK_PERIOD": args.clock_period,
        "FP_SIZING": "relative",
        "FP_CORE_UTIL": args.utilization,
        "PDK": args.pdk
    }
    
    # Ensure standard cell library matches PDK if not explicitly set in config
    if args.pdk == "sky130A":
        config["STD_CELL_LIBRARY"] = "sky130_fd_sc_hd"
    elif args.pdk == "ihp-sg13g2":
        config["STD_CELL_LIBRARY"] = "sg13g2_stdcell"
        
        # Patch OpenLane 1 -> LibreLane configuration gaps for IHP PDK
        config["FILL_CELL"] = "sg13g2_fill_1 sg13g2_fill_2"
        config["DECAP_CELL"] = "sg13g2_decap_*"
        # IHP sg13g2 has NO tapcells - set dist=0 to fully skip tapcell insertion
        # Using fill cells as tapcells causes an infinite OpenROAD hang
        config["FP_TAPCELL_DIST"] = 0
        config["WELLTAP_CELL"] = ""
        config["ENDCAP_CELL"] = ""
        
        # Power Delivery Network explicit vars
        config["FP_PDN_RAIL_OFFSET"] = 0
        config["FP_PDN_VWIDTH"] = 2.2
        config["FP_PDN_VSPACING"] = 4.0
        config["FP_PDN_VPITCH"] = 75.6
        config["FP_PDN_VOFFSET"] = 13.6
        config["FP_PDN_HWIDTH"] = 2.2
        config["FP_PDN_HSPACING"] = 4.0
        config["FP_PDN_HPITCH"] = 75.6
        config["FP_PDN_HOFFSET"] = 13.6
        config["FP_PDN_CORE_RING_VWIDTH"] = 5.0
        config["FP_PDN_CORE_RING_HWIDTH"] = 5.0
        config["FP_PDN_CORE_RING_VSPACING"] = 2.0
        config["FP_PDN_CORE_RING_HSPACING"] = 2.0
        config["FP_PDN_CORE_RING_VOFFSET"] = 4.5
        config["FP_PDN_CORE_RING_HOFFSET"] = 4.5
        config["FP_PDN_RAIL_LAYER"] = "Metal1"
        config["FP_PDN_RAIL_WIDTH"] = 0.44
        config["FP_PDN_HORIZONTAL_LAYER"] = "TopMetal2"
        config["FP_PDN_VERTICAL_LAYER"] = "TopMetal1"

        # Liberty timing files - only typical corner for speed by default
        # IO libs excluded since digital-only designs have no IO pads
        if args.full_timing:
            config["STA_CORNERS"] = ["nom_typ_1p20V_25C", "nom_fast_1p32V_m40C", "nom_slow_1p08V_125C"]
            config["LIB"] = {
                "nom_typ_1p20V_25C": ["/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lib/sg13g2_stdcell_typ_1p20V_25C.lib"],
                "nom_fast_1p32V_m40C": ["/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lib/sg13g2_stdcell_fast_1p32V_m40C.lib"],
                "nom_slow_1p08V_125C": ["/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lib/sg13g2_stdcell_slow_1p08V_125C.lib"]
            }
        else:
            # Fast mode: single typical corner only
            config["STA_CORNERS"] = ["nom_typ_1p20V_25C"]
            config["DEFAULT_CORNER"] = "nom_typ_1p20V_25C"
            config["LIB"] = {
                "nom_typ_1p20V_25C": ["/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lib/sg13g2_stdcell_typ_1p20V_25C.lib"]
            }
        
        # TECH_LEFS and RCX_RULESETS must use exact corner names (not wildcards)
        config["TECH_LEFS"] = {
            "nom_typ_1p20V_25C": "/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lef/sg13g2_tech.lef"
        }
        config["RCX_RULESETS"] = {
            "nom_typ_1p20V_25C": "/foss/pdks/ihp-sg13g2/libs.tech/librelane/openrcx/ihp-sg13g2.nom.magic.rules"
        }
        if args.full_timing:
            config["TECH_LEFS"]["nom_fast_1p32V_m40C"] = "/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lef/sg13g2_tech.lef"
            config["TECH_LEFS"]["nom_slow_1p08V_125C"] = "/foss/pdks/ihp-sg13g2/libs.ref/sg13g2_stdcell/lef/sg13g2_tech.lef"
            config["RCX_RULESETS"]["nom_fast_1p32V_m40C"] = "/foss/pdks/ihp-sg13g2/libs.tech/librelane/openrcx/ihp-sg13g2.nom.magic.rules"
            config["RCX_RULESETS"]["nom_slow_1p08V_125C"] = "/foss/pdks/ihp-sg13g2/libs.tech/librelane/openrcx/ihp-sg13g2.nom.magic.rules"

    config_path = run_dir / "config.json"
    with open(config_path, "w") as f:
        json.dump(config, f, indent=4)
        
    print(f"[*] Generated config.json for {top_module} using {args.pdk} PDK.")

    # Prevent shell environment variables from overriding the script's PDK selections
    env = os.environ.copy()
    if "STD_CELL_LIBRARY" in env:
        del env["STD_CELL_LIBRARY"]
    if "PDK" in env:
        del env["PDK"]

    # 3. Run LibreLane
    print(f"[*] Starting LibreLane synthesis...")
    try:
        cmd = f"cd {run_dir} && rm -rf runs && librelane config.json"
        subprocess.run(cmd, shell=True, check=True, env=env)
        
        print(f"\n[+] Success! Your GDS outputs are available in:\n    {run_dir}/runs/")
        
    except subprocess.CalledProcessError as e:
        print(f"\n[-] Error: LibreLane execution failed (exit code {e.returncode}). see output above.")
        sys.exit(1)

if __name__ == "__main__":
    main()
